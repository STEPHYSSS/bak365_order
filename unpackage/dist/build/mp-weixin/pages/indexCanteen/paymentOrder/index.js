(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/indexCanteen/paymentOrder/index"],{"1e45":function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=r(n("3955")),i=n("bf5e");function r(e){return e&&e.__esModule?e:{default:e}}var a=function(){Promise.all([n.e("common/vendor"),n.e("components/goodsBox/index")]).then(function(){return resolve(n("b0d7"))}.bind(null,n)).catch(n.oe)},s=function(){n.e("components/modeChange/index").then(function(){return resolve(n("e365"))}.bind(null,n)).catch(n.oe)},u=function(){n.e("components/bottomSubmit/index").then(function(){return resolve(n("d78a"))}.bind(null,n)).catch(n.oe)},l=function(){n.e("components_uni/uni-popup/uni-popup").then(function(){return resolve(n("117d"))}.bind(null,n)).catch(n.oe)},d=function(){n.e("components/nodeData/index").then(function(){return resolve(n("7f34"))}.bind(null,n)).catch(n.oe)},c=function(){n.e("components/couponBox/index").then(function(){return resolve(n("63d4"))}.bind(null,n)).catch(n.oe)},h=function(){n.e("components/modeChange/appointment").then(function(){return resolve(n("29f0"))}.bind(null,n)).catch(n.oe)},f=function(){n.e("components_uni/mpvue-picker/mpvuePicker").then(function(){return resolve(n("7910"))}.bind(null,n)).catch(n.oe)},p=function(){Promise.all([n.e("common/vendor"),n.e("components_uni/uni-calendar/uni-calendar")]).then(function(){return resolve(n("a50b"))}.bind(null,n)).catch(n.oe)},m=function(){n.e("components/customerService/index").then(function(){return resolve(n("9797"))}.bind(null,n)).catch(n.oe)},b=function(){Promise.all([n.e("common/vendor"),n.e("components_uni/uni-icons/uni-icons")]).then(function(){return resolve(n("a398"))}.bind(null,n)).catch(n.oe)},g=getApp(),v={components:{goodsBox:a,modeChange:s,bottomSubmit:u,uniPopup:l,noData:d,couponBox:c,changeAbout:h,mpvuePicker:f,unCalendar:p,btnService:m,uniIcons:b},data:function(){return{radio:"weixin"===g.globalData.provider?2:3,allMoney:0,addNum:0,orderObj:{},arrayList:[],colorItem:g.globalData.itemColor,cartList:[],tableNumber:"",showCoupon:!1,dataList:[],isOrder:!0,showInfo:!1,radioCoupon:"0",currentShowStr:"",isChangeCoupon:!1,isChangeCouponBool:null,currentPageLast:!1,pageIndex:1,disabledBtn:!1,provider:g.globalData.provider,colorIndex:g.globalData.colorIndex,createOrderId:null,appointMentType:"",showTime:!1,FinTimeInfo:[],pickerValueDefault:[],aboutTime:{propsAboutTime:"预约取餐",paramsAboutTime:""},currentId:"",isSubscribe:"",FinTimeInfoTwo:[],modeVal:"",MinAmountNew:null,showArea:g.globalData.isPack,currentArea:{},OrderProdAmt:0,freight:"",showMode:!1,currentIndexMode:null,determineDisabled:!1,couponDisabled:!1,showCalendar:!1,currentDate:"",calendarDate:"",pickerDate:"",pickerValueArray:[],isCollage:!1}},created:function(){this.FinTimeInfo=[],this.currentDate=(0,i.formatTime)(new Date,!0)},methods:{setDecimalFun:function(e){return(0,i.setDecimal)(e)},setAllMoney:function(e){return 0==e?.01:e},getObj:function(t){var n=this;this.$showLoads(0,"");var r=P(this),a={data:r};a=JSON.stringify(a);var s="weixin"===this.provider?1:2,u=e.getStorageSync("currentAreaMy")||{};Promise.all([o.default.api("OrderFill.aspx",{ProdStr:a,OrderSource:s,AddressNo:u.AddressNo||""},null,null,"POST"),t?o.default.api("Public/Submit_ajax.aspx",{Type:"GetCouponInfo",PageIndex:1}):"",t?o.default.api("OrderFinTime.aspx",{ProdStr:a},null,null,"POST"):""]).then((function(o){var r=o[1].CouponList||[];0===n.dataList.length&&((0,i.setTime)(r),n.dataList=r||[],n.currentPageLast=o[1].IsNextPage);var a=o[0]||[];n.arrayList=a.ProdInfo,n.arrayList.forEach((function(e){e.num=e.Qty,n.addNum+=Number(e.Qty)}));var s=0;2===n.radio?a.PrefInfo.WxFavorAmt&&(s=Number(a.PrefInfo.WxFavorAmt)):3===n.radio?a.PrefInfo.AlipayFavorAmt&&(s=Number(a.PrefInfo.AlipayFavorAmt)):a.PrefInfo.CardFavorAmt&&(s=Number(a.PrefInfo.CardFavorAmt));var u=Number(a.OrderPayedAmt)-s-n.isChangeCoupon;if(n.currentArea=a.AddressInfo,n.currentArea.Freight&&(u=Number(u)+Number(n.currentArea.Freight)),u=parseFloat(u.toFixed(2)),n.allMoney=u,n.orderObj=a,g.globalData.minAmount=a.MinDistributionAmount||"",n.currentIndexMode=g.globalData.isPack-1,t){n.OrderProdAmt=a.OrderProdAmt;var l={latitude:a.ShopInfo.Latitude||"",longitude:a.ShopInfo.Longitude||""};e.setStorageSync("shopLocation",l)}n.FinTimeInfo=o[2].FinTimeInfo||[],t&&(n.appointMentType="1"!==n.orderObj.WX_OrderAppointMent?"1":n.appointMentType?n.appointMentType:n.orderObj.OrderProdType,n.isSubscribe=n.orderObj.WX_OrderAppointMent),n.$showLoads(1,"")})).catch((function(e){console.log(e,9999)}))},setPackFun:function(){var e=this.orderObj.WX_LogisticsDistribution,t=this.orderObj.WX_OrderEatInStore,n=this.orderObj.WX_OrderEatPackAway,o=(0,i.setModeIf)(e,t,n);o.bool&&("1"==n&&0===this.FinTimeInfoTwo.filter((function(e){return"1"===e["value"]})).length&&this.FinTimeInfoTwo.push({value:"1",label:"打包"}),"1"==t&&0===this.FinTimeInfoTwo.filter((function(e){return"2"===e["value"]})).length&&this.FinTimeInfoTwo.push({value:"2",label:"堂食"}),"1"==e&&0===this.FinTimeInfoTwo.filter((function(e){return"3"===e["value"]})).length&&this.FinTimeInfoTwo.push({value:"3",label:"外卖"}),this.showMode=!0)},getCouponList:function(){var e=this;this.disabledBtn=!0,o.default.api("Public/Submit_ajax.aspx",{Type:"GetCouponInfo",PageIndex:this.pageIndex}).then((function(t){var n=t.CouponList;e.disabledBtn=!1,e.currentPageLast=t.IsNextPage,n.length>0?((0,i.setTime)(n),e.dataList=n||[]):e.pageIndex=e.pageIndex-1})).catch((function(t){e.disabledBtn=!1}))},clickGoodsBox:function(e){},onChange:function(e){if("{}"!==JSON.stringify(this.orderObj.PrefInfo)){var t=2===e?this.orderObj.PrefInfo.WxFavorAmt:3===e?this.orderObj.PrefInfo.AlipayFavorAmt:this.orderObj.PrefInfo.CardFavorAmt,n=Number(this.orderObj.OrderPayedAmt)-Number(t)-this.isChangeCoupon+Number(this.currentArea.Freight);if(n=parseFloat(n.toFixed(2)),1===e&&Number(this.orderObj.PayInfo.WX_CardBalance)<n)return;this.allMoney=n}this.radio=e},determine:function(){var t=this;Number(g.globalData.minAmount)>Number(this.OrderProdAmt)&&"3"==g.globalData.isPack?e.showToast({title:"未到达起送费哦,不含配送费",icon:"none"}):("weixin"!==this.provider||"1"===this.orderObj.PayInfo.WX_WxPay||2!=this.radio)&&("alipay"!==this.provider||"1"===this.orderObj.PayInfo.WX_AlipayPay||3!=this.radio)?this.orderObj.PayInfo.WX_CardBalance<this.allMoney&&1===this.radio?e.showToast({title:"请选择付款方式",icon:"none"}):this.determineDisabled||(this.determineDisabled=!0,this.createOrderId?"weixin"===this.provider?this.subscribeMessage():this.createPayment():this.createOrderFun().then((function(e){"weixin"===t.provider?t.subscribeMessage():t.createPayment()}))):e.showToast({title:"请选择付款方式",icon:"none"})},subscribeMessage:function(){var e=this;try{if(""!=e.tempMessageID){var t=e.tempMessageID.split(",");wx.requestSubscribeMessage({tmplIds:t,success:function(t){e.createPayment()},fail:function(t){setTimeout((function(){e.createPayment()}),1e3)}})}else e.createPayment()}catch(n){setTimeout((function(){e.createPayment()}),1e3)}},createPayment:function(){var t=this;if(e.setStorageSync("cartList",[]),1==this.radio)this.determineDisabled=!1,e.redirectTo({url:"../cardPayment/index?id="+this.createOrderId});else{var n="weixin"===this.provider?"/Public/WxPay/WxPay.aspx":"/Public/AliPay/AliPay.aspx";o.default.api(n,{OrderID:this.createOrderId}).then((function(e){(0,i.weChatPayment)(g,t.createOrderId,e),t.determineDisabled=!1})).catch((function(e){t.determineDisabled=!1}))}},createOrderFun:function(){var t=this;return new Promise((function(n,i){if(2===Number(t.appointMentType)&&!t.aboutTime.paramsAboutTime)return e.showToast({title:"请选择预约时间",icon:"none"}),void(t.determineDisabled=!1);var r=P(t),a={data:r};a=JSON.stringify(a);var s="weixin"===t.provider?1:2,u={ProdStr:a,OrderSource:s,MemoStr:t.inputValue||"",PrefNo:(1==t.radio?t.orderObj.PrefInfo.CardPrefNo:"weixin"===t.provider?t.orderObj.PrefInfo.WxPrefNo:t.orderObj.PrefInfo.AlipayPrefNo)||"",PayType:1==t.radio?1:2,CodeNo:t.radioCoupon||"",CodePayed:t.isChangeCoupon||0,AppointMentType:t.appointMentType,FinTime:1===Number(t.appointMentType)?"":t.aboutTime.paramsAboutTime,AddressNo:3==g.globalData.isPack?t.currentArea.AddressNo:""};t.radioCoupon&&0!=t.radioCoupon||(delete u.CodeNo,delete u.CodePayed),t.$showLoads(0,""),o.default.api("OrderSubmit.aspx",u,null,null,"POST").then((function(e){t.$showLoads(1,""),t.createOrderId=e.OrderID,t.tempMessageID=e.TempMessageID||"",t.determineDisabled=!1,n()})).catch((function(n){e.showToast({title:n,icon:"none"}),t.determineDisabled=!1,i()}))}))},routerBindCard:function(){e.navigateTo({url:"../../indexVip/cardBind/index?order="+!0})},changeMode:function(e){2===e&&(this.showCalendar=!0,this.calendarDate=this.aboutTime.pickerDate),this.appointMentType=e},getTimeList:function(e){var t=this;this.$showLoads(0,"");var n=P(this),i={data:n};i=JSON.stringify(i),o.default.api("OrderFinTime.aspx",{ProdStr:i,FinDate:e},null,null,"POST").then((function(e){var n=e.FinTimeInfo[0].Time;n.forEach((function(e,t){n[t]={label:e,value:e}})),t.FinTimeInfo.push(e.FinTimeInfo[0]),t.pickerValueArray=n,t.$showLoads(1,"")})).catch((function(e){}))},bindKeyInput:function(e){this.inputValue=e.detail.value},changeCoupon:function(){this.dataList.length>0&&(this.showCoupon=!0)},onCloseCoupon:function(e){e.show||(this.showCoupon=!1)},onCloseMode:function(e){e.show||(this.showMode=!1)},clickMode:function(e){this.showMode=!1;var t=Number(e)+1;t&&(g.globalData.isPack=t,this.modeVal="1"==t?"打包":"2"==t?"堂食":"外卖"),this.getObj()},onClickCoupon:function(e){if(!e)return this.showCoupon=!1,this.allMoney=this.allMoney+this.isChangeCoupon,this.allMoney=parseFloat(this.allMoney.toFixed(2)),this.radioCoupon=0,void(this.isChangeCoupon=0);this.couponDisabled||(this.couponDisabled=!0,this.radioCoupon=e,this.judgeCanUser(e))},onClicknoCoupon:function(){},judgeCanUser:function(e){var t=this,n=(this.orderObj,P(this)),i={data:n};i=JSON.stringify(i);var r={ProdStr:i,CodeNo:e};o.default.api("CouponUseChk.aspx",r,null,null,"POST").then((function(e){t.allMoney=t.allMoney+t.isChangeCoupon;var n=0;n=t.allMoney-Number(e.CodePayed),n=parseFloat(n.toFixed(2)),t.showCoupon=!1,t.isChangeCoupon=Number(e.CodePayed),t.isChangeCouponBool=e.CodePayed,Number(n)<=0&&(n=.01),t.allMoney=n,t.currentId=e.CodeNo,t.couponDisabled=!1})).catch((function(e){t.couponDisabled=!1}))},onCloseInfo:function(e){e.show||(this.showInfo=!1)},viewMore:function(e){this.showInfo=!0,this.currentShowStr=e},clickPage:function(t){this.disabledBtn||(1==t?this.pageIndex>1?(this.pageIndex--,this.getCouponList()):e.showToast({title:"这是第一页",icon:"none"}):0===Number(this.currentPageLast)?e.showToast({title:"这是最后一页",icon:"none"}):(this.pageIndex++,this.getCouponList()))},onConfirmTime:function(e){this.showCalendar=!1;var t=e.label.split("-");this.aboutTime={propsAboutTime:this.pickerDate+" "+e.label,paramsAboutTime:this.pickerDate+" "+t[0]+":00",pickerDate:this.pickerDate},this.calendarDate=this.pickerDate},onConfirmTimeTwo:function(){},ShopPhone:function(){e.makePhoneCall({phoneNumber:this.orderObj.ShopInfo.ShopTel})},changeArea:function(){e.navigateTo({url:"/pages/indexCanteen/areaList/areaList?OptType=1"})},confirmDate:function(e){var t=this;this.pickerDate=e.fulldate;var n=this.FinTimeInfo.filter((function(t){return t.Date===e.fulldate}));n.length>0?(this.pickerValueArray=n[0].Time,this.pickerValueArray.forEach((function(e,n){t.pickerValueArray[n].hasOwnProperty("label")||(t.pickerValueArray[n]={label:e,value:e})}))):(this.pickerValueArray=[],this.getTimeList(e.fulldate)),this.$refs.mpvuePicker.show()},calendarRevert:function(){this.showCalendar=!1}},onLoad:function(t){this.isCollage=t.isCollage||!1,e.removeStorageSync("currentAreaMy")},onShow:function(){var t=this;if(g.globalData.isPack||(console.log("订单消失"),e.redirectTo({url:"/pages/indexCanteen/index"})),!this.createOrderId){var n=g.globalData.isPack;this.modeVal="1"==n?"打包":"2"==n?"堂食":"外卖",this.isCollage?(this.cartList=e.getStorageSync("listCollage"),setTimeout((function(){e.removeStorageSync("listCollage")}),300)):this.cartList=e.getStorageSync("cartList"),this.cartList.length>0&&this.cartList.forEach((function(e,n){0===e.num&&t.cartList.splice(n,1)})),this.tableNumber=g.globalData.tableNumber,g.globalData.openID?(this.getObj(!0),this.provider=g.globalData.provider):this.$store.dispatch("Login").then((function(e){t.getObj(!0),t.provider=g.globalData.provider}))}},watch:{}};function P(e){var t=e.cartList.slice();e.addNum=0;for(var n=0;n<t.length;n++){var o=t[n];o.prodQty=o.num,o.prodTast=o.recordFlavor?o.recordFlavor.join(","):"";delete o.ProdImg,delete o.FeaturesHtmlInfo,delete o.CarouselImgInfo}return t}t.default=v}).call(this,n("543d")["default"])},8501:function(e,t,n){"use strict";n.r(t);var o=n("db92"),i=n("94cb");for(var r in i)"default"!==r&&function(e){n.d(t,e,(function(){return i[e]}))}(r);n("a775");var a,s=n("f0c5"),u=Object(s["a"])(i["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],a);t["default"]=u.exports},"93f9":function(e,t,n){"use strict";(function(e){n("b895");o(n("66fd"));var t=o(n("8501"));function o(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,n("543d")["createPage"])},"94cb":function(e,t,n){"use strict";n.r(t);var o=n("1e45"),i=n.n(o);for(var r in o)"default"!==r&&function(e){n.d(t,e,(function(){return o[e]}))}(r);t["default"]=i.a},"97dd":function(e,t,n){},a775:function(e,t,n){"use strict";var o=n("97dd"),i=n.n(o);i.a},db92:function(e,t,n){"use strict";var o,i=function(){var e=this,t=e.$createElement,n=(e._self._c,e.setDecimalFun(e.orderObj.OrderProdAmt)),o=e.setDecimalFun(e.orderObj.OrderPackingFeeAmt),i=e.setDecimalFun(e.currentArea.Freight),r=e.setDecimalFun(e.isChangeCoupon),a=e.setAllMoney(e.allMoney);e.$mp.data=Object.assign({},{$root:{m0:n,m1:o,m2:i,m3:r,m4:a}})},r=[];n.d(t,"b",(function(){return i})),n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){return o}))}},[["93f9","common/runtime","common/vendor"]]]);